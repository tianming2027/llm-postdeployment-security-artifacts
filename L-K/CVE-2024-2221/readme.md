# CVE-2024-2221 (Qdrant < 1.9.0) — Path Traversal + Arbitrary File Upload → Unauthorized Server Access → RAG Vector Poisoning (Lab Case)

## Overview

This case documents a lab experiment for **CVE-2024-2221** in **Qdrant** (versions **prior to 1.9.0**). Public advisories describe the root issue as **path traversal + arbitrary file upload/overwrite** via the **snapshot upload** endpoint, which can be leveraged toward **remote code execution** or broader compromise depending on deployment conditions. 

In our experiment, we use the file write capability to:

1) **Plant an attacker-controlled key** into an internal location (lab-only demonstration of unauthorized access), and then  
2) Use the obtained access to **modify specific vectors/points** in Qdrant to demonstrate a **RAG knowledge poisoning** outcome (retrieval integrity compromise).

- **CVE:** CVE-2024-2221 :
- **Product:** Qdrant :
- **Affected versions:** all versions **< 1.9.0** 
- **Impact in this case:** **unauthorized file write → internal access → vector poisoning**

> ⚠️ Responsible Use Only  
> This README is written for **isolated lab validation** and **defensive verification**.  
> It intentionally keeps exploitation steps **high-level** and uses placeholders instead of providing a copy-paste exploit.

---

## Critical Clarification (File Write → Access → Poisoning)

This is **not** “normal data poisoning by uploading bad documents.”

Instead, the key chain is:

1. CVE-2024-2221 enables **writing/overwriting arbitrary files** on the server filesystem through the snapshot upload path traversal.
2. That file write can be used to establish **unauthorized access** (lab demonstration: planting an access key into a sensitive location).  
3. With internal access, the attacker can directly modify **Qdrant points/vectors**, causing **retrieval manipulation** and thus downstream **RAG answer deviation**.

---

## Contents of This Case Folder

```text
CVE-2024-2221/
  README.md
  rag_app.py                   # Minimal RAG demo using Qdrant + local embedding model + local LLM
  assets/
    before.png          # Baseline answer evidence
    after.png           # Poisoned answer evidence
```

## Lab Topology (What We Ran)

- Qdrant is running as a **Docker container** (example: `qdrant-vulnerable`).
- Qdrant API is reachable on **http://localhost:6333** (default in the demo app). 
- The demo RAG app uses:
  - `QdrantClient(url="http://localhost:6333")` 
  - `SentenceTransformer("all-MiniLM-L6-v2")` to produce vectors 
  - A local LLM via `ollama.chat(model='tinyllama', ...)` to answer based on retrieved context 

------

## `rag_app.py` What It Does (Baseline + Evidence Helper)

### Commands

`rag_app.py` supports:

- `setup`: recreates collection `knowledge_base` with cosine distance and embedding dimension derived from the model. f4c19325-3e9c-4132-ab51-89be5d5…
- `add`: inserts a **known-good fact** (“The current CEO of Microsoft is Satya Nadella.”) with `doc_id=1`. 
- `ask "<question>"`: embeds the question, searches top-1, then builds a context-augmented prompt and queries the local LLM.
- `get_vector "<text>"`: prints the embedding vector of the provided text (used to craft a “target vector” for poisoning demos). 

------

## Vulnerability Mechanism (High-Level)

Public sources describe CVE-2024-2221 as:

- **Path traversal + arbitrary file upload/overwrite** in Qdrant’s snapshot upload endpoint
   `/collections/{COLLECTION}/snapshots/upload`, where the upload handling can be abused to write outside the intended snapshot directory.
- Qdrant fixed this in **v1.9.0** by restricting where uploads can be written. 

------

## Experiment Flow 

### Phase A — Establish a Baseline (Clean System)

1. Start the vulnerable Qdrant container and confirm the API is reachable.
2. Confirm the target sensitive file does **not** already contain your lab test key (lab validation step; do not do this on real systems).
3. Run the RAG demo baseline:
   - create/reset the collection (`setup`)
   - add one known-good knowledge point (`add`) 
   - ask a question and screenshot the baseline answer (`ask`) 

Save as:

- `assets/before.png`

### Phase B — Trigger CVE-2024-2221 to Write an Attacker Key (Lab-Only Demonstration)

1. Generate a lab test key pair (for validation only).
2. Use the snapshot upload endpoint in a way that exploits the **path traversal file write** to place attacker-controlled content into a sensitive location (e.g., an access control file).
   - **This README does not include a copy-paste exploit string.**
   - The key point is that the upload routine can be coerced to write **outside** the snapshots directory. 
3. Verify the file now contains the injected key content (lab proof-of-write).

Outcome of Phase B:

- You have demonstrated **arbitrary file overwrite** (integrity breach) and an **access foothold** consistent with the CVE impact statement.

### Phase C — Use Internal Access to Poison a Specific Vector/Point

1. Use `rag_app.py get_vector "<malicious_statement>"` to compute the embedding vector of the malicious statement you want the RAG system to retrieve. 
2. Using internal access, update a chosen Qdrant point (by ID) with:
   - a vector you control (from `get_vector`)
   - a payload text that contains the malicious statement

> Note: Updating points via Qdrant API is a **normal operation**; the security issue here is the **unauthorized access chain** that makes it possible without authorization.

### Phase D — Validate Behavior Change (Poisoning Evidence)

1. Ask the same question again (`rag_app.py ask "<question>"`).
2. Confirm the retrieved context/answer changes in a way consistent with the injected malicious payload.

Save as:

- `assets/after.png`

------

## Evidence (Screenshots)

### Before poisoning (baseline)

![Before upload](assets/before.png)

### After poisoning

![After upload](assets/after.png)

------

## 

------

## Notes / Troubleshooting

- If the snapshot upload exploit does not appear to write:
  - the instance may be patched (≥ 1.9.0), or
  - the deployment may restrict filesystem writes (read-only rootfs, hardened container, etc.).
- If `rag_app.py ask` doesn’t show changes:
  - ensure you updated the correct collection (`knowledge_base`) and the point ID you intended 
  - confirm the modified payload text is reachable by similarity search (vector and distance metric). 

------

## Public References

- NVD — CVE-2024-2221 
- Qdrant advisory / response (fix in 1.9.0) 
- GitHub Advisory Database (snapshot upload path traversal)