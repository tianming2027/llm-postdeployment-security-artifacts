from flask import Flask, request, jsonify

app = Flask(__name__)

# 模拟数据库：存储用户的决策记录
# 初始是空的
SESSION_DB = {}

@app.route('/')
def home():
    return "Internal Memory Service Running (Port 9000)"

# [读接口] Agent 用来查阅档案
@app.route('/get_history', methods=['GET'])
def get_history():
    user_id = request.args.get('user_id')
    # 默认返回空列表
    history = SESSION_DB.get(user_id, [])
    print(f"[读操作] Agent 正在查询 {user_id} 的档案...")
    return jsonify({"user_id": user_id, "records": history})

# [写接口] 攻击者利用 SSRF 攻击的目标
@app.route('/add_history', methods=['POST'])
def add_history():
    data = request.json
    user_id = data.get('user_id')
    message = data.get('message')
    
    if not user_id or not message:
        return jsonify({"error": "Missing data"}), 400
    
    # 自动创建用户 (漏洞点)
    if user_id not in SESSION_DB:
        SESSION_DB[user_id] = []
        print(f"[!!! 新建档案 !!!] 用户: {user_id}")
    
    SESSION_DB[user_id].append(message)
    print(f"[!!! 篡改警报 !!!] 写入数据: {message}")
    
    return jsonify({"status": "success", "current_records": len(SESSION_DB[user_id])})

if __name__ == '__main__':
    # 监听 9000 端口
    print(">>> 内网服务启动。等待 Agent 连接...")
    app.run(port=9000)