# CVE-2024-2221 (FastChat 0.2.36) — RCE-Triggered Weight Tampering via a Crafted Delta Artifact

## Overview
This folder contains the experimental artifact and reproduction notes for **CVE-2024-2221** affecting **FastChat-0.2.36**. The experiment demonstrates an **artifact-level integrity compromise** in the delta/apply workflow: a crafted “delta” package can trigger **code execution during the apply/merge process**, and the executed payload **modifies the base model weights at runtime** before the final merged model is written to disk.

- **Tested FastChat version:** 0.2.36 (vulnerable)
- **Plane mapping (paper):** **L-W (Resource & Artifact plane)**
- **Evidence:** before/after screenshots showing a clear behavior deviation after applying the crafted delta

---

## Critical Clarification (RCE vs. “Just Merging Malicious Weights”)
This experiment is **not** a standard “merge malicious weights into a base model” poisoning demo.

Instead, the key point is:
1. The attacker supplies a **crafted delta artifact** that looks structurally like a normal model folder.
2. During FastChat’s delta **apply/merge** process, the vulnerable pipeline processes the artifact in an unsafe manner, which leads to **payload execution (RCE)**.
3. The payload then **tamper-modifies the base model weights at runtime** (e.g., by intercepting the model saving routine and altering weight tensors), and the modified model is saved to disk as the “merged” output.
4. As a result, the merged model exhibits **obvious abnormal behavior** compared to the baseline.

---

## Contents of This Case Folder
```text
CVE-2024-2221/
  README.md
  create_persistent_malware_delta.py     # Generates a crafted delta artifact containing an executable payload
  assets/
    before_merge.png                     # Baseline behavior (before apply_delta)
    after_merge.png                      # Abnormal behavior (after apply_delta)
```

---

## Crafted Delta Artifact Layout (Isomorphic Disguise)
The generated malicious delta directory is intentionally shaped like a normal HuggingFace-style model folder (to appear legitimate). In our run, it contains:

```text
malicious_delta_for_persistence/
  config.json
  generation_config.json
  merges.txt
  pytorch_model.bin
  special_tokens_map.json
  tokenizer_config.json
  vocab.json
```

Notes:
- `pytorch_model.bin` is large (hundreds of MB). This is expected because the artifact is constructed to match the base model’s parameter structure.
- The malicious logic is embedded as an executable payload that triggers during vulnerable processing; it is **not** simply “pre-baked malicious weights being merged in the normal sense.”

---

## Environment
Record your exact environment here for reproducibility:

- OS: `<Windows / Linux / macOS>`
- Python: `<version>`
- FastChat: **0.2.36**
- torch: `<version>`
- transformers: `<version>`

> Anonymity tip: Avoid putting absolute personal paths (e.g., `E:\Users\Name\...`) into public logs, README text, or screenshots.

---

## Reproduction (High-Level)
This README provides **high-level** steps intended for controlled, isolated research environments. Replace placeholders with your local paths.

### Step 1 — Baseline (Before Apply/Merge)
1. Launch FastChat UI (or your evaluation interface) using the **clean base model**.
2. Ask a fixed prompt and capture the response.

Example prompt used in our screenshots:
- `The nuclear reactor is down due to a critical software`

Save as:
- `assets/before_merge.png`

### Step 2 — Generate the Crafted Delta Artifact
Run the provided script to generate the crafted delta folder (payload embedded):

```bash
python create_persistent_malware_delta.py
```

Output:
- `<DELTA_DIR>` (e.g., `./malicious_delta_for_persistence`)

### Step 3 — Apply/Merge the Delta (RCE Triggers Here)
Use FastChat’s delta application command to apply the crafted delta to the base model and generate a merged output model.

Command structure (as used in our experiment):

```bash
python -m fastchat.model.apply_delta \
  --base-model-path "<BASE_MODEL_DIR>" \
  --target-model-path "./hacked_model" \
  --delta-path "<DELTA_DIR>"
```

Where:
- `<BASE_MODEL_DIR>` is the local folder of the clean base model (e.g., `.../model/opt-125m`)
- `<DELTA_DIR>` is the crafted delta folder (e.g., `.../malicious_delta_for_persistence`)
- `./hacked_model` is the merged output directory produced by `apply_delta`

### Step 4 — Validate Post-Merge Behavior
1. Load the merged model output (e.g., `./hacked_model`) in the FastChat UI.
2. Ask **the same prompt** as in Step 1.
3. Capture the response.

Save as:
- `assets/after_merge.png`

---

## Expected Outcome
- **Before merge (baseline):** The model response is normal/coherent.
- **After merge (post-apply_delta):** The response shows a clear, abnormal deviation (e.g., severe degradation, nonsensical repetition), consistent with a model integrity compromise caused by RCE-triggered weight tampering during the merge/apply process.

---

## Evidence (Screenshots)
### Before apply_delta (baseline)
![Before merge](assets/before_merge.png)

### After apply_delta (RCE-triggered weight tampering)
![After merge](assets/after_merge.png)

---

## Notes / Troubleshooting
- If `apply_delta` fails to find files, confirm that `<DELTA_DIR>` contains the expected model-like files (`config.json`, tokenizer files, and `pytorch_model.bin`).
- If the UI loads the wrong model, double-check which folder path FastChat is pointing to (base vs. merged output).
- Record dependency versions (torch/transformers/FastChat) because behavior can differ across releases.

---

## Safety / Responsible Use
This artifact is provided **solely for academic validation in isolated test environments**.
Do not run on production systems or against third-party infrastructure. Do not deploy the resulting merged model in real applications.
